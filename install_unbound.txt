#!/bin/bash
# Instala Unbound, cria estrutura básica de configuração e baixa root-servers.

set -e

LOG_FILE="/var/log/unbound_install.log"
ERROR_LOG="/var/log/unbound_install_error.log"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;36m'
NC='\033[0m'

mkdir -p /var/log
touch "$LOG_FILE" "$ERROR_LOG"

log() {
  echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
  echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1" | tee -a "$LOG_FILE" "$ERROR_LOG"
}

log_success() {
  echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')] SUCCESS:${NC} $1" | tee -a "$LOG_FILE"
}

check_error() {
  if [ $? -ne 0 ]; then
    log_error "$1"
  fi
}

if [ "$EUID" -ne 0 ]; then
  log_error "Este script deve ser executado como root."
  echo -e "${RED}Este script deve ser executado como root.${NC}"
  exit 1
fi

check_port_53() {
  log "Verificando se a porta 53 está em uso..."
  echo -e "${BLUE}Verificando porta 53...${NC}"

  local PORT_CHECK=""
  if command -v netstat >/dev/null 2>&1; then
    PORT_CHECK=$(netstat -tulpn 2>/dev/null | grep ":53 ")
  elif command -v ss >/dev/null 2>&1; then
    PORT_CHECK=$(ss -tulpn 2>/dev/null | grep ":53 ")
  fi

  if [ -n "$PORT_CHECK" ]; then
    log_error "Porta 53 em uso:"
    echo "$PORT_CHECK" | tee -a "$LOG_FILE"
    echo -e "${RED}A porta 53 já está em uso. Ajuste manualmente antes de prosseguir.${NC}"
    exit 1
  else
    log_success "Porta 53 está livre."
  fi
}

check_unbound_config() {
  if command -v unbound-checkconf >/dev/null 2>&1; then
    unbound-checkconf >/dev/null 2>&1
    return $?
  else
    /usr/sbin/unbound -n -d -vvv >/dev/null 2>&1
    return $?
  fi
}

echo -e "\n${BLUE}===== Instalação base do Unbound =====${NC}"

check_port_53

if [ -d "/etc/unbound" ]; then
  backup_dir="/etc/unbound.backup.$(date +%Y%m%d%H%M%S)"
  log "Criando backup de /etc/unbound em $backup_dir"
  cp -r /etc/unbound "$backup_dir"
  check_error "Falha ao criar backup de /etc/unbound"
fi

log "Atualizando índices de pacotes (apt-get update)..."
apt-get update -y >>"$LOG_FILE" 2>>"$ERROR_LOG" || true

log "Instalando pacotes: unbound dnsutils..."
apt-get install -y unbound dnsutils >>"$LOG_FILE" 2>>"$ERROR_LOG"

log "Habilitando serviço unbound no boot..."
systemctl enable unbound >>"$LOG_FILE" 2>>"$ERROR_LOG" || true

log "Parando unbound antes de reconfigurar..."
systemctl stop unbound >>"$LOG_FILE" 2>>"$ERROR_LOG" || true
sleep 2

mkdir -p /etc/unbound/unbound.conf.d

log "Baixando root-servers (named.root) para /etc/unbound/named.cache..."
if ! wget -q -4 -O /etc/unbound/named.cache https://www.internic.net/domain/named.root; then
  log_error "Falha ao baixar named.root via wget, tentando curl..."
  if ! curl -fsSL -o /etc/unbound/named.cache https://www.internic.net/domain/named.root; then
    log_error "Falha ao obter named.root. Unbound pode funcionar, mas sem cache hyperlocal."
  else
    log_success "named.root baixado via curl."
  fi
else
  log_success "named.root baixado com sucesso."
fi

if [ -f /etc/unbound/named.cache ]; then
  log "Processando named.cache para gerar root-servers-*.dat..."
  grep -v '^;' /etc/unbound/named.cache > /tmp/nc-nocmts.txt
  grep -v ' NS ' /tmp/nc-nocmts.txt > /tmp/nc-ipaddr.txt
  awk '{print $1";"$4}' /tmp/nc-ipaddr.txt > /tmp/nc-table.dat
  cut -d';' -f2 /tmp/nc-table.dat > /tmp/nc-iponly.dat

  cp /tmp/nc-table.dat   /etc/unbound/root-servers-table.dat || true
  cp /tmp/nc-iponly.dat  /etc/unbound/root-servers-ips.dat   || true
  grep -v ':' /tmp/nc-iponly.dat > /etc/unbound/root-servers-ipv4.dat || true
  grep ':'   /tmp/nc-iponly.dat > /etc/unbound/root-servers-ipv6.dat  || true

  log_success "Arquivos root-servers-*.dat gerados."
fi

log "Limpando configs antigas em /etc/unbound/unbound.conf.d..."
rm -f /etc/unbound/unbound.conf.d/*.conf 2>/dev/null || true

log "Criando /etc/unbound/unbound.conf..."
cat << 'EOF' > /etc/unbound/unbound.conf

server:
    module-config: "respip validator iterator"

include-toplevel: "/etc/unbound/unbound.conf.d/*.conf"

EOF

log "Configurando DNSSEC root trust anchor..."
cat << 'EOF' > /etc/unbound/unbound.conf.d/21-root-auto-trust-anchor-file.conf
server:
    auto-trust-anchor-file: "/var/lib/unbound/root.key"
EOF

mkdir -p /var/lib/unbound
chown unbound:unbound /var/lib/unbound
chmod 755 /var/lib/unbound

if command -v unbound-anchor >/dev/null 2>&1; then
  log "Executando unbound-anchor para obter root.key..."
  unbound-anchor -a /var/lib/unbound/root.key >>"$LOG_FILE" 2>>"$ERROR_LOG" || true
fi

log "Configurando estatísticas..."
cat << 'EOF' > /etc/unbound/unbound.conf.d/31-statisticas.conf
server:
    statistics-interval: 0
    extended-statistics: yes
    statistics-cumulative: no
EOF

log "Configurando protocolos (IPv4/IPv6, TCP/UDP)..."
cat << 'EOF' > /etc/unbound/unbound.conf.d/41-protocols.conf
server:
    do-ip4: yes
    do-ip6: yes
    do-udp: yes
    do-tcp: yes
EOF

log "Configurando ACLs básicas para redes privadas..."
cat << 'EOF' > /etc/unbound/unbound.conf.d/51-acls-locals.conf
server:
    # Loopback
    access-control: 127.0.0.1/32 allow
    access-control: ::1/128 allow

    # RFC1918 / CGNAT
    access-control: 10.0.0.0/8 allow
    access-control: 172.16.0.0/12 allow
    access-control: 192.168.0.0/16 allow
    access-control: 100.64.0.0/10 allow

    # IPv6 locais (ULA + link-local)
    access-control: fc00::/7 allow
    access-control: fe80::/10 allow
EOF

log "Criando arquivo para ACLs de redes públicas / de cliente..."
cat << 'EOF' > /etc/unbound/unbound.conf.d/52-acls-trusteds.conf
server:
    # Redes públicas / de clientes (preenchidas pelo script configure_network_blocks.sh)
    # Exemplo:
    # access-control: 200.200.200.0/24 allow
    # access-control: 2804:xxxx::/48 allow
EOF

log "Configurando política padrão de negação (deny all)..."
cat << 'EOF' > /etc/unbound/unbound.conf.d/59-acls-default-policy.conf
server:
    access-control: 0.0.0.0/0 deny
    access-control: ::/0 deny
EOF

log "Criando arquivo de tuning vazio (será sobrescrito pelo tuning_unbound.sh)..."
cat << 'EOF' > /etc/unbound/unbound.conf.d/61-configs.conf
server:
    # Este arquivo será sobrescrito pelo tuning_unbound.sh com valores ajustados à máquina.
EOF

log "Configurando interfaces de escuta..."
cat << 'EOF' > /etc/unbound/unbound.conf.d/62-listen.conf
server:
    interface: 127.0.0.1
    interface: ::1
    interface: 0.0.0.0
    interface: ::0
EOF

if [ -f /etc/unbound/root-servers-ips.dat ]; then
  log "Configurando Hyperlocal Cache com root-servers-ips.dat..."
  {
    echo "server:"
    echo "    auth-zone:"
    echo "        name: \".\""
    while read -r addr; do
      [ -n "$addr" ] && echo "        master: $addr"
    done < /etc/unbound/root-servers-ips.dat
    echo "        fallback-enabled: yes"
    echo "        for-downstream: no"
    echo "        for-upstream: yes"
    echo "        zonefile: \"\""
  } > /etc/unbound/unbound.conf.d/89-hyperlocal-cache.conf
fi

log "Configurando remote-control para unbound-control..."
cat << 'EOF' > /etc/unbound/unbound.conf.d/99-remote-control.conf
remote-control:
    control-enable: yes
    control-interface: 127.0.0.1
    control-port: 953
    control-use-cert: "no"
    control-interface: /run/unbound.ctl
EOF

log "Ajustando permissões de /etc/unbound e /var/lib/unbound..."
chown -R unbound:unbound /etc/unbound
chmod -R 755 /etc/unbound
chown -R unbound:unbound /var/lib/unbound
chmod -R 755 /var/lib/unbound

log "Verificando sintaxe da configuração Unbound..."
if ! check_unbound_config; then
  log_error "Configuração do Unbound contém erros. Verifique arquivos em /etc/unbound/unbound.conf.d/"
else
  log_success "Configuração do Unbound validada com sucesso."
fi

log "Iniciando serviço unbound..."
systemctl start unbound >>"$LOG_FILE" 2>>"$ERROR_LOG" || true
sleep 2

if systemctl is-active unbound >/dev/null 2>&1; then
  log_success "Unbound iniciado com sucesso."
else
  log_error "Unbound não está ativo. Verifique logs em syslog/journalctl."
fi

echo -e "${GREEN}Instalação base do Unbound concluída.${NC}"
